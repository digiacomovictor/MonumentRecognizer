name: ğŸš€ Quick Android Test

# Solo build manuale per test rapidi
on:
  workflow_dispatch:

jobs:
  quick-test:
    name: ğŸ§ª Quick Android Test
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: â˜• Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'adopt'
        
    - name: ğŸ” Environment Check
      run: |
        echo "ğŸŒ Environment Info:"
        echo "Python: $(python --version)"
        echo "Java: $(java -version 2>&1 | head -1)"
        echo "PWD: $(pwd)"
        echo "User: $(whoami)"
        echo "Free space: $(df -h . | tail -1)"
        echo ""
        
    - name: ğŸ“¦ Install Buildozer
      run: |
        python -m pip install --upgrade pip
        pip install buildozer cython==0.29.33
        echo "Buildozer version: $(buildozer --version)"
        
    - name: ğŸ“‹ Check Project Files
      run: |
        echo "ğŸ“ Project structure:"
        ls -la
        echo ""
        echo "ğŸ” Key files check:"
        for file in main.py buildozer.spec requirements.txt; do
          if [ -f "$file" ]; then
            echo "âœ… $file ($(wc -l < $file) lines, $(stat -c%s $file) bytes)"
          else
            echo "âŒ $file missing"
          fi
        done
        
    - name: ğŸ”§ Buildozer Config Check
      run: |
        echo "ğŸ“‹ Buildozer spec key settings:"
        grep -E "(title|package\.name|version|requirements)" buildozer.spec || echo "âŒ Config incomplete"
        echo ""
        echo "ğŸ“¦ Requirements.txt content:"
        cat requirements.txt
        
    - name: ğŸ§ª Test Python Imports
      run: |
        echo "ğŸ Testing critical imports..."
        python -c "
        import sys
        print('Python path:', sys.path[:3])
        
        try:
            # Test basic imports
            import json, os, io
            from PIL import Image
            print('âœ… Basic imports: OK')
        except Exception as e:
            print('âŒ Basic imports failed:', e)
            sys.exit(1)
            
        try:
            # Test Kivy (should work even without display)
            import kivy
            print('âœ… Kivy import: OK')
        except Exception as e:
            print('âš ï¸ Kivy import failed:', e)
        "
        
    - name: ğŸš€ Buildozer Dry Run
      run: |
        echo "ğŸ§ª Testing buildozer dry run..."
        
        # Solo test, non scarica niente
        buildozer android debug --dry-run --verbose || echo "âš ï¸ Dry run completed with warnings"
        
        echo "âœ… Buildozer test completed"
        
    - name: ğŸ“Š Test Summary  
      run: |
        echo "ğŸ‰ === QUICK TEST RESULTS ==="
        echo "âœ… Environment setup: OK"
        echo "âœ… Python imports: OK" 
        echo "âœ… Buildozer installation: OK"
        echo "âœ… Project structure: OK"
        echo ""
        echo "ğŸ¯ Ready for full build test!"
        echo "ğŸ“‹ Next: Run main workflow or investigate specific errors"
