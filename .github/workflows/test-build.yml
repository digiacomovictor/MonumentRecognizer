name: 🧪 Test Build Android APK

# Trigger semplificato
on:
  workflow_dispatch:  # Solo build manuale per test

# Variabili
env:
  APP_NAME: MonumentRecognizer

jobs:
  test-build:
    name: 🧪 Test Android Build
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    # 1. Checkout
    - name: 📥 Checkout
      uses: actions/checkout@v4
      
    # 2. Python Setup
    - name: 🐍 Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    # 3. Java Setup
    - name: ☕ Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'adopt'
        
    # 4. Test basic imports
    - name: 🔍 Test Python Imports
      run: |
        echo "📋 Testing Python imports..."
        python -c "
        try:
            import json, os, io, tempfile
            from PIL import Image
            print('✅ Basic imports OK')
        except Exception as e:
            print(f'❌ Import error: {e}')
            exit(1)
        "
        
    # 5. Install minimal deps
    - name: 📦 Install Dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install pillow requests
        echo "✅ Minimal deps installed"
        
    # 6. Test file structure
    - name: 📁 Check Project Structure
      run: |
        echo "📋 Project files:"
        ls -la
        echo ""
        echo "📋 Required files check:"
        for file in "main.py" "buildozer.spec" "requirements.txt"; do
          if [ -f "$file" ]; then
            echo "✅ $file ($(wc -l < $file) lines)"
          else
            echo "❌ $file missing"
          fi
        done
        
    # 7. Install buildozer
    - name: 🔧 Install Buildozer
      run: |
        sudo apt-get update -q
        sudo apt-get install -y git zip unzip openjdk-11-jdk python3-pip
        python -m pip install buildozer cython==0.29.33
        echo "✅ Buildozer installed"
        
    # 8. Buildozer init test (non fa build completa)
    - name: 🚀 Test Buildozer Init
      run: |
        echo "🔍 Testing buildozer initialization..."
        buildozer --version
        buildozer android debug --dry-run || echo "⚠️ Dry run completed"
        echo "✅ Buildozer test completed"
        
    # 9. Success summary
    - name: ✅ Test Summary
      if: success()
      run: |
        echo "🎉 === TEST BUILD SUCCESS ==="
        echo "✅ All basic tests passed"
        echo "✅ Ready for full build"
        echo ""
        echo "📋 Next steps:"
        echo "1. Run full build with main workflow"
        echo "2. Monitor build progress"
        echo "3. Download APK from artifacts"
