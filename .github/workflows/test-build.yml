name: ğŸ§ª Test Build Android APK

# Trigger semplificato
on:
  workflow_dispatch:  # Solo build manuale per test

# Variabili
env:
  APP_NAME: MonumentRecognizer

jobs:
  test-build:
    name: ğŸ§ª Test Android Build
    runs-on: ubuntu-latest
    timeout-minutes: 60
    
    steps:
    # 1. Checkout
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      
    # 2. Python Setup
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    # 3. Java Setup
    - name: â˜• Setup Java
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'adopt'
        
    # 4. Test basic imports
    - name: ğŸ” Test Python Imports
      run: |
        echo "ğŸ“‹ Testing Python imports..."
        python -c "
        try:
            import json, os, io, tempfile
            from PIL import Image
            print('âœ… Basic imports OK')
        except Exception as e:
            print(f'âŒ Import error: {e}')
            exit(1)
        "
        
    # 5. Install minimal deps
    - name: ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install pillow requests
        echo "âœ… Minimal deps installed"
        
    # 6. Test file structure
    - name: ğŸ“ Check Project Structure
      run: |
        echo "ğŸ“‹ Project files:"
        ls -la
        echo ""
        echo "ğŸ“‹ Required files check:"
        for file in "main.py" "buildozer.spec" "requirements.txt"; do
          if [ -f "$file" ]; then
            echo "âœ… $file ($(wc -l < $file) lines)"
          else
            echo "âŒ $file missing"
          fi
        done
        
    # 7. Install buildozer
    - name: ğŸ”§ Install Buildozer
      run: |
        sudo apt-get update -q
        sudo apt-get install -y git zip unzip openjdk-11-jdk python3-pip
        python -m pip install buildozer cython==0.29.33
        echo "âœ… Buildozer installed"
        
    # 8. Buildozer init test (non fa build completa)
    - name: ğŸš€ Test Buildozer Init
      run: |
        echo "ğŸ” Testing buildozer initialization..."
        buildozer --version
        buildozer android debug --dry-run || echo "âš ï¸ Dry run completed"
        echo "âœ… Buildozer test completed"
        
    # 9. Success summary
    - name: âœ… Test Summary
      if: success()
      run: |
        echo "ğŸ‰ === TEST BUILD SUCCESS ==="
        echo "âœ… All basic tests passed"
        echo "âœ… Ready for full build"
        echo ""
        echo "ğŸ“‹ Next steps:"
        echo "1. Run full build with main workflow"
        echo "2. Monitor build progress"
        echo "3. Download APK from artifacts"
