name: ğŸ”¬ Android Diagnostic v3

on:
  workflow_dispatch:
  push:
    paths:
      - '.github/workflows/android-diagnostic-v3.yml'

jobs:
  diagnostic:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: â˜• Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: ğŸ“‹ System Information
      timeout-minutes: 2
      run: |
        echo "ğŸ–¥ï¸  SYSTEM INFO:"
        echo "================"
        uname -a
        python --version
        java -version
        echo "ğŸ’¾ Disk space:"
        df -h
        echo "ğŸ§  Memory:"
        free -h
        echo "âš™ï¸  Environment:"
        env | grep -E "(ANDROID|JAVA|PATH)" | head -10
        
    - name: ğŸ“‚ Project Structure Analysis
      timeout-minutes: 2
      run: |
        echo "ğŸ“ PROJECT STRUCTURE:"
        echo "===================="
        ls -la
        echo ""
        echo "ğŸ“± App files:"
        find . -name "*.py" -type f | head -10
        echo ""
        echo "âš™ï¸  Config files:"
        ls -la *.spec *.cfg *.ini 2>/dev/null || echo "No config files found"
        
    - name: ğŸ” Buildozer Spec Analysis  
      timeout-minutes: 2
      run: |
        echo "ğŸ“‹ BUILDOZER SPEC ANALYSIS:"
        echo "=========================="
        if [ -f "buildozer.spec" ]; then
          echo "âœ… buildozer.spec found"
          echo ""
          echo "ğŸ¯ Key settings:"
          grep -E "(title|package\.name|package\.domain|source\.dir|requirements|android\.ndk)" buildozer.spec || true
          echo ""
          echo "ğŸ“ File size: $(wc -l < buildozer.spec) lines"
        else
          echo "âŒ buildozer.spec NOT found!"
          echo "This is likely the main problem."
        fi
        
    - name: ğŸ§ª Requirements Analysis
      timeout-minutes: 2  
      run: |
        echo "ğŸ“¦ REQUIREMENTS ANALYSIS:"
        echo "========================"
        if [ -f "requirements.txt" ]; then
          echo "âœ… requirements.txt found"
          echo "ğŸ“¦ Dependencies:"
          cat requirements.txt
          echo ""
          echo "ğŸ“Š Count: $(wc -l < requirements.txt) packages"
        else
          echo "âŒ requirements.txt not found"
        fi
        
        # Check for problematic dependencies
        echo ""
        echo "ğŸš¨ Checking for problematic dependencies..."
        if [ -f "requirements.txt" ]; then
          if grep -E "(tensorflow|torch|opencv|numpy|pandas)" requirements.txt; then
            echo "âš ï¸  Found heavy ML/scientific packages - these can cause Android build issues"
          fi
          if grep -E "(kivy|kivymd)" requirements.txt; then
            echo "âœ… Found Kivy packages - good for Android"
          fi
        fi
        
    - name: ğŸ¯ Main App Analysis
      timeout-minutes: 2
      run: |
        echo "ğŸ¯ MAIN APP ANALYSIS:"
        echo "===================="
        echo "ğŸ“‚ Looking for main app file..."
        
        # Look for common main files
        for file in main.py app.py run.py __main__.py; do
          if [ -f "$file" ]; then
            echo "âœ… Found: $file"
            echo "ğŸ“ Size: $(wc -l < "$file") lines"
            echo "ğŸ” Imports:"
            head -20 "$file" | grep -E "^(import|from)" | head -5
          fi
        done
        
        # Check for Kivy imports
        echo ""
        echo "ğŸ“± Android compatibility check:"
        if find . -name "*.py" -exec grep -l "kivy\|kivymd" {} \; | head -3; then
          echo "âœ… Found Kivy usage - good for Android"
        else
          echo "âš ï¸  No Kivy imports found - might not be Android-ready"
        fi
        
    - name: ğŸ”§ Buildozer Test Installation
      timeout-minutes: 5
      run: |
        echo "ğŸ”§ BUILDOZER INSTALLATION TEST:"
        echo "==============================="
        echo "ğŸ“¦ Installing buildozer..."
        pip install buildozer cython
        echo "âœ… Buildozer version:"
        buildozer version
        echo ""
        echo "ğŸ§ª Testing buildozer initialization..."
        if [ ! -f "buildozer.spec" ]; then
          echo "ğŸ“‹ Creating buildozer.spec..."
          buildozer init
          echo "âœ… buildozer.spec created successfully"
        fi
        
    - name: ğŸš¨ Critical Issues Check
      timeout-minutes: 3
      run: |
        echo "ğŸš¨ CRITICAL ISSUES CHECK:"
        echo "========================"
        
        ISSUES=0
        
        # Check 1: buildozer.spec
        if [ ! -f "buildozer.spec" ]; then
          echo "âŒ CRITICAL: No buildozer.spec file"
          ISSUES=$((ISSUES + 1))
        fi
        
        # Check 2: main app file
        if [ ! -f "main.py" ] && [ ! -f "app.py" ]; then
          echo "âŒ CRITICAL: No main.py or app.py found"
          ISSUES=$((ISSUES + 1))
        fi
        
        # Check 3: Kivy dependency
        if [ -f "requirements.txt" ]; then
          if ! grep -q "kivy" requirements.txt; then
            echo "âš ï¸  WARNING: No Kivy in requirements.txt"
            ISSUES=$((ISSUES + 1))
          fi
        fi
        
        echo ""
        echo "ğŸ“Š DIAGNOSTIC RESULT:"
        echo "===================="
        if [ $ISSUES -eq 0 ]; then
          echo "âœ… No critical issues found - should be buildable"
        else
          echo "âŒ Found $ISSUES critical issue(s)"
          echo "ğŸ”§ These need to be fixed before Android build will work"
        fi
        
        # Recommendations
        echo ""
        echo "ğŸ’¡ RECOMMENDATIONS:"
        echo "=================="
        echo "1. Ensure buildozer.spec exists and is properly configured"
        echo "2. Make sure main.py exists and uses Kivy"
        echo "3. Add required dependencies to requirements.txt"
        echo "4. Test locally with: buildozer android debug"
        
    - name: ğŸ“‹ Generate Report
      if: always()
      run: |
        echo "ğŸ“‹ GENERATING DIAGNOSTIC REPORT..."
        
        cat > diagnostic_report.md << 'EOF'
        # ğŸ”¬ Android Build Diagnostic Report
        
        ## ğŸ“Š System Environment
        - OS: Ubuntu Latest (GitHub Actions)
        - Python: 3.9
        - Java: 17 (Temurin)
        
        ## ğŸ“ Project Analysis
        EOF
        
        if [ -f "buildozer.spec" ]; then
          echo "- âœ… buildozer.spec: Found" >> diagnostic_report.md
        else
          echo "- âŒ buildozer.spec: Missing (CRITICAL)" >> diagnostic_report.md
        fi
        
        if [ -f "main.py" ]; then
          echo "- âœ… main.py: Found" >> diagnostic_report.md
        else
          echo "- âŒ main.py: Missing (CRITICAL)" >> diagnostic_report.md
        fi
        
        if [ -f "requirements.txt" ]; then
          echo "- âœ… requirements.txt: Found" >> diagnostic_report.md
        else
          echo "- âš ï¸  requirements.txt: Missing" >> diagnostic_report.md
        fi
        
        echo "" >> diagnostic_report.md
        echo "## ğŸ’¡ Next Steps" >> diagnostic_report.md
        echo "Based on this diagnostic, the build process should focus on:" >> diagnostic_report.md
        echo "1. Fixing any critical missing files" >> diagnostic_report.md
        echo "2. Configuring buildozer.spec properly" >> diagnostic_report.md 
        echo "3. Testing with minimal dependencies first" >> diagnostic_report.md
        
        echo "âœ… Diagnostic report generated"
        
    - name: ğŸ“¤ Upload Diagnostic Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: android-diagnostic-report
        path: |
          diagnostic_report.md
        retention-days: 30
