#!/usr/bin/env python3
"""
üß™ Test Sistema Autenticazione Utenti
Testa tutte le funzionalit√† del sistema di login e gestione utenti
"""

import os
import sys
import json
import sqlite3
from datetime import datetime

def test_user_system():
    """Testa il sistema di gestione utenti."""
    print("üîç Test UserSystem...")
    
    try:
        from user_system import UserSystem, User
        
        # Usa un database di test
        test_db = "test_users.db"
        if os.path.exists(test_db):
            os.remove(test_db)
        
        user_system = UserSystem(test_db)
        
        print("   ‚úÖ UserSystem inizializzato")
        
        # Test registrazione utente
        success, message, user = user_system.register_user(
            username="testuser",
            email="test@example.com",
            full_name="Test User",
            password="Password123!"
        )
        
        if success:
            print(f"   ‚úÖ Registrazione riuscita: {user.username}")
        else:
            print(f"   ‚ùå Registrazione fallita: {message}")
            return False
        
        # Test login
        success, message, logged_user = user_system.login_user("testuser", "Password123!")
        
        if success:
            print(f"   ‚úÖ Login riuscito: {logged_user.full_name}")
        else:
            print(f"   ‚ùå Login fallito: {message}")
            return False
        
        # Test sessione
        if user_system.is_logged_in():
            print("   ‚úÖ Utente loggato correttamente")
        else:
            print("   ‚ùå Stato login non corretto")
            return False
        
        # Test statistiche utente
        stats = user_system.get_user_stats()
        if stats and 'username' in stats:
            print(f"   ‚úÖ Statistiche utente: {stats['username']}")
        else:
            print("   ‚ùå Errore nelle statistiche")
            return False
        
        # Test logout
        user_system.logout_user()
        if not user_system.is_logged_in():
            print("   ‚úÖ Logout riuscito")
        else:
            print("   ‚ùå Logout fallito")
            return False
        
        # Test login con credenziali sbagliate
        success, message, _ = user_system.login_user("testuser", "password_sbagliata")
        if not success:
            print("   ‚úÖ Credenziali sbagliate respinte correttamente")
        else:
            print("   ‚ùå Credenziali sbagliate accettate erroneamente")
            return False
        
        # Pulisci database di test
        user_system = None  # Assicura che la connessione sia chiusa
        if os.path.exists(test_db):
            try:
                os.remove(test_db)
            except PermissionError:
                print(f"   ‚ö†Ô∏è Impossibile rimuovere {test_db} (in uso)")
        
        print("   ‚úÖ UserSystem funziona correttamente")
        return True
        
    except Exception as e:
        print(f"   ‚ùå Errore UserSystem: {e}")
        return False

def test_auth_ui_imports():
    """Testa che le interfacce UI si importino correttamente."""
    print("\nüîç Test Auth UI Imports...")
    
    try:
        from auth_ui import LoginScreen, RegisterScreen, ProfileScreen, AuthManager
        from user_system import UserSystem
        
        # Crea un sistema utenti di test
        test_db = "test_ui_users.db"
        if os.path.exists(test_db):
            os.remove(test_db)
        
        user_system = UserSystem(test_db)
        
        # Test creazione AuthManager
        auth_manager = AuthManager(user_system)
        
        if auth_manager.screen_manager:
            print("   ‚úÖ AuthManager creato con ScreenManager")
        else:
            print("   ‚ùå AuthManager senza ScreenManager")
            return False
        
        # Test che le schermate siano state create
        screen_names = [screen.name for screen in auth_manager.screen_manager.screens]
        expected_screens = ['login', 'register', 'profile']
        
        for screen_name in expected_screens:
            if screen_name in screen_names:
                print(f"   ‚úÖ Schermata '{screen_name}' creata")
            else:
                print(f"   ‚ùå Schermata '{screen_name}' mancante")
                return False
        
        # Pulisci
        auth_manager = None  # Assicura che la connessione sia chiusa
        user_system = None
        if os.path.exists(test_db):
            try:
                os.remove(test_db)
            except PermissionError:
                print(f"   ‚ö†Ô∏è Impossibile rimuovere {test_db} (in uso)")
        
        print("   ‚úÖ Auth UI si importa correttamente")
        return True
        
    except Exception as e:
        print(f"   ‚ùå Errore Auth UI: {e}")
        return False

def test_database_structure():
    """Testa la struttura del database."""
    print("\nüîç Test Database Structure...")
    
    try:
        from user_system import UserSystem
        
        test_db = "test_db_structure.db"
        if os.path.exists(test_db):
            os.remove(test_db)
        
        user_system = UserSystem(test_db)
        
        # Controlla le tabelle create
        with sqlite3.connect(test_db) as conn:
            cursor = conn.cursor()
            
            # Lista tabelle
            cursor.execute("SELECT name FROM sqlite_master WHERE type='table';")
            tables = [row[0] for row in cursor.fetchall()]
            
            expected_tables = ['users', 'user_sessions', 'login_attempts', 'password_resets']
            
            for table in expected_tables:
                if table in tables:
                    print(f"   ‚úÖ Tabella '{table}' creata")
                else:
                    print(f"   ‚ùå Tabella '{table}' mancante")
                    return False
            
            # Controlla struttura tabella users
            cursor.execute("PRAGMA table_info(users);")
            columns = [row[1] for row in cursor.fetchall()]
            
            expected_columns = ['user_id', 'username', 'email', 'full_name', 'password_hash', 'salt']
            
            for column in expected_columns:
                if column in columns:
                    print(f"   ‚úÖ Colonna users.{column} presente")
                else:
                    print(f"   ‚ùå Colonna users.{column} mancante")
                    return False
        
        # Pulisci
        user_system = None  # Assicura che la connessione sia chiusa
        if os.path.exists(test_db):
            try:
                os.remove(test_db)
            except PermissionError:
                print(f"   ‚ö†Ô∏è Impossibile rimuovere {test_db} (in uso)")
        
        print("   ‚úÖ Struttura database corretta")
        return True
        
    except Exception as e:
        print(f"   ‚ùå Errore struttura database: {e}")
        return False

def test_password_security():
    """Testa la sicurezza delle password."""
    print("\nüîç Test Password Security...")
    
    try:
        from user_system import UserSystem
        
        test_db = "test_password_security.db"
        if os.path.exists(test_db):
            os.remove(test_db)
        
        user_system = UserSystem(test_db)
        
        # Test password deboli
        weak_passwords = [
            "123",          # Troppo corta
            "password",     # Senza maiuscole, numeri, simboli
            "Password",     # Senza numeri, simboli
            "Password123",  # Senza simboli
            "PASSW0RD123!"  # Senza minuscole
        ]
        
        for weak_pwd in weak_passwords:
            success, message, _ = user_system.register_user(
                f"test_{weak_pwd[:3]}", 
                f"test_{weak_pwd[:3]}@example.com", 
                "Test User", 
                weak_pwd
            )
            
            if not success:
                print(f"   ‚úÖ Password debole respinta: {weak_pwd[:8]}...")
            else:
                print(f"   ‚ùå Password debole accettata: {weak_pwd[:8]}...")
                return False
        
        # Test password forte
        strong_password = "StrongPass123!@#"
        success, message, user = user_system.register_user(
            "stronguser", 
            "strong@example.com", 
            "Strong User", 
            strong_password
        )
        
        if success:
            print("   ‚úÖ Password forte accettata")
        else:
            print(f"   ‚ùå Password forte respinta: {message}")
            return False
        
        # Test che la password sia hashata nel database
        with sqlite3.connect(test_db) as conn:
            cursor = conn.cursor()
            cursor.execute("SELECT password_hash, salt FROM users WHERE username = ?", ("stronguser",))
            result = cursor.fetchone()
            
            if result and result[0] != strong_password and result[1]:
                print("   ‚úÖ Password hashata correttamente con salt")
            else:
                print("   ‚ùå Password non hashata correttamente")
                return False
        
        # Pulisci
        user_system = None  # Assicura che la connessione sia chiusa
        if os.path.exists(test_db):
            try:
                os.remove(test_db)
            except PermissionError:
                print(f"   ‚ö†Ô∏è Impossibile rimuovere {test_db} (in uso)")
        
        print("   ‚úÖ Sicurezza password funziona correttamente")
        return True
        
    except Exception as e:
        print(f"   ‚ùå Errore sicurezza password: {e}")
        return False

def test_session_management():
    """Testa la gestione delle sessioni."""
    print("\nüîç Test Session Management...")
    
    try:
        from user_system import UserSystem
        
        test_db = "test_sessions.db"
        if os.path.exists(test_db):
            os.remove(test_db)
        
        user_system = UserSystem(test_db)
        
        # Registra e logga utente
        user_system.register_user("sessionuser", "session@example.com", "Session User", "SessionPass123!")
        success, message, user = user_system.login_user("sessionuser", "SessionPass123!")
        
        if not success:
            print("   ‚ùå Login fallito per test sessioni")
            return False
        
        # Verifica che sia stata creata una sessione
        if user_system.session_token:
            print("   ‚úÖ Token di sessione creato")
            
            # Test validazione sessione
            is_valid = user_system.validate_session(user_system.session_token)
            if is_valid:
                print("   ‚úÖ Sessione valida")
            else:
                print("   ‚ùå Sessione non valida")
                return False
            
            # Test che la sessione rimanga valida
            old_token = user_system.session_token
            
            # Crea una nuova istanza del sistema per testare il ripristino
            from user_system import UserSystem as NewUserSystem
            new_user_system = NewUserSystem(test_db)
            
            if new_user_system.restore_session(old_token):
                print("   ‚úÖ Sessione ripristinata")
            else:
                print("   ‚ùå Ripristino sessione fallito")
                return False
        else:
            print("   ‚ùå Token di sessione non creato")
            return False
        
        # Pulisci
        user_system = None  # Assicura che la connessione sia chiusa
        if os.path.exists(test_db):
            try:
                os.remove(test_db)
            except PermissionError:
                print(f"   ‚ö†Ô∏è Impossibile rimuovere {test_db} (in uso)")
        
        print("   ‚úÖ Gestione sessioni funziona correttamente")
        return True
        
    except Exception as e:
        print(f"   ‚ùå Errore gestione sessioni: {e}")
        return False

def main():
    """Esegue tutti i test del sistema utenti."""
    print("=" * 60)
    print("üß™ TEST SISTEMA AUTENTICAZIONE UTENTI")
    print("   Monument Recognizer v2.0")
    print("=" * 60)
    
    tests = [
        ("Sistema Utenti Base", test_user_system),
        ("Interfacce UI", test_auth_ui_imports),
        ("Struttura Database", test_database_structure),
        ("Sicurezza Password", test_password_security),
        ("Gestione Sessioni", test_session_management),
    ]
    
    results = []
    
    for test_name, test_func in tests:
        try:
            result = test_func()
            results.append((test_name, result))
        except Exception as e:
            print(f"   üí• Errore critico in {test_name}: {e}")
            results.append((test_name, False))
    
    # Riassunto
    print("\n" + "=" * 60)
    print("üìä RIASSUNTO TEST AUTENTICAZIONE")
    print("=" * 60)
    
    passed = 0
    for test_name, result in results:
        status = "‚úÖ PASS" if result else "‚ùå FAIL"
        print(f"   {status} {test_name}")
        if result:
            passed += 1
    
    print(f"\nüéØ Test passati: {passed}/{len(tests)}")
    
    if passed == len(tests):
        print("üéâ TUTTI I TEST SONO PASSATI!")
        print("üöÄ Il sistema di autenticazione √® pronto!")
        print("\nüí° Prossimi passi:")
        print("   ‚Ä¢ Integrare con l'app principale")
        print("   ‚Ä¢ Collegare con il sistema visite")
        print("   ‚Ä¢ Implementare sincronizzazione cloud")
    else:
        print("‚ö†Ô∏è  Alcuni test sono falliti. Controlla i messaggi sopra.")
    
    print("\nüîß Per testare manualmente le UI:")
    print("   ‚Ä¢ Crea un'app Kivy che usa AuthManager")
    print("   ‚Ä¢ Testa login/registrazione/profilo")
    print("   ‚Ä¢ Verifica persistenza sessioni")

if __name__ == "__main__":
    main()
